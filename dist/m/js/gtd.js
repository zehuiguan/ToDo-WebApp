define(["util"],function(a){function b(b){var c,d=a.$(".list-menu").getElementsByTagName("*"),g=[];if(b){for(var h=b||window.event,i=h.target||h.srcElement,j=0;j<d.length;j++)if("choose"===d[j].className){d[j].className="";break}if(i.className="choose","未完成"===i.innerHTML)c=!1;else{if("已完成"!==i.innerHTML)return void l(f);c=!0}}else if("未完成"===a.$(".list-menu .choose").innerHTML)c=!1;else{if("已完成"!==a.$(".list-menu .choose").innerHTML)return void l(f);c=!0}for(var k=0;k<f.length;k++)for(var m=0;m<e.length;m++)f[k]===e[m].id&&e[m].finish===c&&g.push(e[m].id);l(g)}var c,d,e,f=[],g="#type";location.hash=g;var h=function(){var a='[{"id": 0,"name": "默认分类","child": [0]}]',b='[{"id": 0,"name": "默认子分类","child": [0],"father": 0}]',f='[{"id": 0,"name": "使用说明","father": 0,"finish": false,"date": "2015-07-01","content": "本应用为离线应用，数据存储在本地硬盘\\n\\n在左侧边缘向右滑动可返回上一页\\n\\n左侧为分类列表\\n中间为当前分类下的任务列表\\n右侧为任务详情\\n\\n可以添加删除分类，添加任务，修改任务（标题、时间），以及给任务标记是否完成等功能。\\n\\nby Zach Kwan\\nhttp://zehuiguan.github.io"}]';localStorage.getItem("catalog")||(localStorage.catalog=a,localStorage.childCatalog=b,localStorage.task=f),c=JSON.parse(localStorage.catalog),d=JSON.parse(localStorage.childCatalog),e=JSON.parse(localStorage.task),j(),i()},i=function(){a.delegateEvent(a.$(".type-wrap"),"h2","click",C),a.delegateEvent(a.$(".type-wrap"),"h3","click",C),a.delegateEvent(a.$(".type-wrap"),"h4","click",C),a.delegateEvent(a.$(".type-wrap"),"span","click",D),a.delegateEvent(a.$(".type-wrap"),"i","click",E),a.addClickEvent(a.$(".type .add"),n),a.addClickEvent(a.$(".list .add"),q),a.addClickEvent(a.$(".task-finish"),B),a.addClickEvent(a.$(".task-edit"),t),a.delegateEvent(a.$(".list-wrap"),"li","click",F),a.delegateEvent(a.$(".list-wrap"),"h6","click",G),a.delegateEvent(a.$(".list-wrap"),"span","click",H),a.addClickEvent(a.$(".btn4"),s),a.delegateEvent(a.$(".list-wrap"),"i","click",w)},j=function(){a.addClass(a.$("#type-all"),"choose"),A();for(var b="",e=0;e<c.length;e++){b+='<li><h3><i class="icon-folder-open"></i><span>'+c[e].name+"</span>&nbsp;&nbsp;("+c[e].num+")",b+="默认分类"==c[e].name?'<i class="icon-cancel type-delete hide"></i>':'<i class="icon-cancel type-delete"></i>',b+='</h3><ul class="item">';for(var f=0;f<c[e].child.length;f++){var g=x(d,"id",c[e].child[f]);b+='<li><h4><i class="icon-doc"></i><span>'+g.name+"</span>&nbsp;&nbsp;("+g.child.length+")",b+="默认子分类"==g.name?'<i class="icon-cancel type-delete hide"></i>':'<i class="icon-cancel type-delete"></i>',b+="</h4></li>"}b+="</ul></li>"}a.$(".item-wrap").innerHTML=b},k=function(){var g=a.$(".type .choose"),h=g.tagName.toLowerCase(),i=g.getElementsByTagName("span")[0].innerHTML;switch(f=[],h){case"h2":for(var j=0;j<e.length;j++)f.push(e[j].id);b();break;case"h3":for(var k=x(c,"name",i),j=0;j<k.child.length;j++)for(var l=x(d,"id",k.child[j]),m=0;m<l.child.length;m++)f.push(l.child[m]);b();break;case"h4":for(var l=x(d,"name",i),m=0;m<l.child.length;m++)f.push(l.child[m]);b()}},l=function(b){for(var c,d=(a.$(".list-wrap .choose"),[]),f=0;f<b.length;f++)c=x(e,"id",b[f]),d.push(c.date);d=a.uniqArray(d),d=z(d);for(var g="",f=0;f<d.length;f++){g+="<li><h5>"+d[f]+'</h5><ul class="item">';for(var h=0;h<b.length;h++)c=x(e,"id",b[h]),c.date===d[f]&&(g+='<li id="listItem">',c.finish===!0?g+='<h6 class="list-finish">':c.finish===!1&&(g+="<h6>"),g+="<span>"+c.name+'</span><i class="icon-cancel list-delete"></i></h6></li>');g+="</ul></li>"}a.$(".list-wrap").innerHTML=g,a.$(".list-wrap").hasChildNodes()&&a.$(".list-wrap").getElementsByTagName("li")[0].hasChildNodes()&&(a.$(".list-wrap").getElementsByTagName("li")[0].getElementsByTagName("ul")[0].getElementsByTagName("li")[0].className="choose")},m=function(){var b=a.$(".list-wrap .choose"),c=[],d=a.$(".task").getElementsByTagName("span");if(a.$(".list-wrap").hasChildNodes()){var f=b.getElementsByTagName("span")[0].innerHTML;c=x(e,"name",f),d[0].innerHTML=c.name,d[1].innerHTML=c.date,a.$("#content-edit").value=c.content,a.$(".task-status").style.display="block",a.$("#content-edit").style.display="block"}else d[0].innerHTML="",d[1].innerHTML="",a.$("#content-edit").value="",a.$(".task-status").style.display="none"},n=function(){a.$(".box").style.display="block",a.$(".overlay").style.display="block",a.$(".box-name").innerHTML="新增分类";for(var b='<p>新分类名称:<input type="text" class="new-type" placeholder="在此输入新分类的名称"></p><p>新分类父节点:<select class="type-select"><option value="-1">无</option>',c=a.$(".item-wrap"),d=c.getElementsByTagName("h3"),e=0;e<d.length;e++)b+='<option value="'+e+'">'+d[e].getElementsByTagName("span")[0].innerHTML+"</option>";b+='</select></p><p class="error"></p><button class="mybutton btn1">确定</button><button class="mybutton btn2">取消</button>',a.$(".box-main").innerHTML=b,a.addClickEvent(a.$(".btn1"),o),a.addClickEvent(a.$(".btn2"),p)},o=function(){var b=a.$(".new-type").value,e=a.$(".type-select").value;if(b=a.trim(b),a.$(".error").innerHTML="",0===b.length)return void(a.$(".error").innerHTML="分类名称不能为空");if(b.length>=10)return void(a.$(".error").innerHTML="分类名称不能多于10个字符");if(x(c,"name",b)&&"-1"===e)return void(a.$(".error").innerHTML="检测到相同名称的分类已存在");if(x(d,"name",b)&&x(d,"name",b).father===c[a.$(".type-select").value].id)return void(a.$(".error").innerHTML="检测到相同名称的子分类已存在");if("-1"===e){var f={id:c[c.length-1].id+1,name:b,child:[],num:0};c.push(f),v()}else{var g={id:d[d.length-1].id+1,name:b,child:[],father:c[a.$(".type-select").value].id},h=x(c,"id",g.father);h.child.push(g.id),d.push(g),v()}j(),p()},p=function(){a.$(".box").style.display="none",a.$(".overlay").style.display="none"},q=function(){a.removeEvent(a.$(".list .add"),q),a.$(".task-title input").value="",a.$(".task-date input").value="",a.$(".task-content textarea").value="",a.addClickEvent(a.$(".task-content .btn3"),r),a.$(".task-title span").style.display="none",a.$(".task-date span").style.display="none",a.$(".task-title input").style.display="inline",a.$(".task-date input").style.display="inline",a.$(".task-content textarea").readOnly=!1,a.addClass(a.$("#content-edit"),"content-edit-border"),a.$(".task-content .btn3").style.display="block",a.$(".task-content .btn4").style.display="block",a.$(".task-content .task-error").style.visibility="visible",a.$(".task-status").style.display="none",window.location.href="#task"},r=function(){console.log("in");var b=a.$(".task-title input").value,f=a.$(".task-date input").value,g=a.$(".task-content textarea").value,h=f.split("-");if(a.$(".task-error").innerHTML="",0===b.length)return void(a.$(".task-error").innerHTML="任务标题不能为空");if(0===f.length)return void(a.$(".task-error").innerHTML="任务日期不能为空");if(!f.match(/^\d{4}-\d{2}-\d{2}$/))return void(a.$(".task-error").innerHTML="任务日期格式错误");if(h[1]<1||h[1]>12||h[2]<1||h[2]>31)return void(a.$(".task-error").innerHTML="日期错误");if(x(e,"name",b))return void(a.$(".task-error").innerHTML="存在相同名称的任务");if(0===g.length)return void(a.$(".task-error").innerHTML="任务内容不能为空");var i,l=a.$(".type-wrap .choose"),n=l.tagName.toLowerCase(),o=0;switch(n){case"h2":i=0,o=1;break;case"h3":var p=l.getElementsByTagName("span")[0].innerHTML,q=x(c,"name",p);if(q.child.length>0)i=q.child[0];else{var t={id:d[d.length-1].id+1,name:"子分类",child:[],father:q.id};q.child.push(t.id),d.push(t),i=t.id}break;case"h4":var u=l.getElementsByTagName("span")[0].innerHTML;i=x(d,"name",u).id}var w={id:e.length-1>=0?e[e.length-1].id+1:0,name:b,father:i,finish:!1,date:f,content:g};e.push(w);var y=x(d,"id",w.father);y.child.push(w.id),v(),k(),function(){for(var c=a.$(".list-wrap").getElementsByTagName("*"),d=0;d<c.length;d++)if("choose"===c[d].className){c[d].className="";break}for(var e=a.$(".list-wrap").getElementsByTagName("h6"),f=e.length,g=0;f>g;g++)b===e[g].getElementsByTagName("span")[0].innerHTML&&(e[g].className="choose")}(),m(),j(),s(),a.removeEvent(a.$(".task-content .btn3"),"click",r)},s=function(){""==a.$("#content-edit").value&&(location.hash="#list"),a.$(".task-title input").style.display="none",a.$(".task-date input").style.display="none",a.$(".task-content .btn3").style.display="none",a.$(".task-content .btn4").style.display="none",a.$(".task-title span").style.display="inline",a.$(".task-date span").style.display="inline",a.$("#content-edit").readOnly=!0,a.removeClass(a.$("#content-edit"),"content-edit-border"),a.$(".task-content .task-error").style.visibility="hidden",a.$(".task-status").style.display="block",a.$(".task-error").innerHTML="",a.addClickEvent(".list .add",q)},t=function(){var b=a.$(".task-title span").innerHTML,c=a.$(".task-date span").innerHTML,d=a.$("#content-edit").value,f=x(e,"name",b);a.removeEvent(a.$(".list .add"),q),editSaveTemp=function(){u(f)},a.addClickEvent(a.$(".task-content .btn3"),editSaveTemp),a.$(".task-title span").style.display="none",a.$(".task-date span").style.display="none",a.$("#content-edit").readOnly=!1,a.addClass(a.$("#content-edit"),"content-edit-border"),a.$(".task-title input").style.display="inline",a.$(".task-date input").style.display="inline",a.$(".task-content .task-error").style.visibility="visible",a.$(".task-content .btn3").style.display="block",a.$(".task-content .btn4").style.display="block",a.$(".task-status").style.display="none",a.$(".task-title input").value=b,a.$(".task-date input").value=c,a.$(".task-content textarea").value=d},u=function(b){a.removeEvent(a.$(".list .add"),q);var c=a.$(".task-title input").value,d=a.$(".task-date input").value,f=a.$(".task-content textarea").value,g=d.split("-");return console.log(d),a.$(".task-error").innerHTML="",0===c.length?void(a.$(".task-error").innerHTML="任务标题不能为空"):0===d.length?void(a.$(".task-error").innerHTML="任务日期不能为空"):d.match(/^\d{4}-\d{2}-\d{2}$/)?g[1]<1||g[1]>12||g[2]<1||g[2]>31?void(a.$(".task-error").innerHTML="日期错误"):x(e,"name",name)?void(a.$(".task-error").innerHTML="检测到相同名称的任务已存在"):0===f.length?void(a.$(".task-error").innerHTML="任务内容不能为空"):(b.name=c,b.date=d,b.content=f,v(),k(),m(),s(),void a.removeEvent(".task-content .btn3","click",editSaveTemp)):void(a.$(".task-error").innerHTML="任务日期格式错误")},v=function(){localStorage.catalog=JSON.stringify(c),localStorage.childCatalog=JSON.stringify(d),localStorage.task=JSON.stringify(e)},w=function(){if(window.event?window.event.cancelBubble=!0:event.stopPropagation(),confirm("删除操作不可逆，确认删除？")){var a,b=this.parentNode.tagName.toLowerCase(),f=this.parentNode.getElementsByTagName("span")[0].innerHTML;switch(b){case"h3":a=y(c,"name",f);for(var g=0;g<c[a].child.length;g++){for(var h=y(d,"id",c[a].child[g]),i=0;i<d[h].child.length;i++){var l=y(e,"id",d[h].child[i]);e.splice(l,1)}d.splice(h,1)}c.splice(a,1);break;case"h4":a=y(d,"name",f);var m=x(c,"id",d[a].father);m.child.splice(m.child.indexOf(d[a].id),1);for(var g=0;g<d[a].child.length;g++){var l=y(e,"id",d[a].child[g]);e.splice(l,1)}d.splice(a,1);break;case"h6":a=y(e,"name",f);var m=x(d,"id",e[a].father);m.child.splice(m.child.indexOf(e[a].id),1),e.splice(a,1)}v(),k(),j()}},x=function(a,b,c){for(var d=0;d<a.length;d++)if(a[d][b]===c)return a[d]},y=function(a,b,c){for(var d=0;d<a.length;d++)if(a[d][b]===c)return d},z=function(a){return a.sort(function(a,b){return a.replace(/-/g,"")-b.replace(/-/g,"")})},A=function(){for(var a,b=0;b<c.length;b++){a=0;for(var e=0;e<c[b].child.length;e++){var f=x(d,"id",c[b].child[e]).child.length;a+=f}c[b].num=a}},B=function(){var b=a.$(".task-title span").innerHTML,c=x(e,"name",b);return c.finish?void alert("任务已经完成"):void(confirm("确定设置为已完成状态？")&&(alert("成功设置！"),c.finish=!0,v(),j(),k()))},C=function(){if("分类列表"!=this.getElementsByTagName("span")[0].innerHTML){for(var b=a.$(".type").getElementsByTagName("*"),c=0;c<b.length;c++)if("choose"===b[c].className){b[c].className="";break}this.className="choose",k(),window.location.href="#list"}},D=function(){this.parentNode.click()},E=function(){-1==this.className.indexOf("icon-cancel")?this.parentNode.click():w.call(this)},F=function(){for(var b=a.$(".list-wrap").getElementsByTagName("*"),c=0;c<b.length;c++)if("choose"===b[c].className){b[c].className="";break}this.className="choose",m(),window.location.href="#task"},G=function(){this.parentNode.click()},H=function(){this.parentNode.parentNode.click()};a.delegateEvent(a.$(".list-menu"),"li","click",b);var I=window.innerWidth>0?window.innerWidth:screen.width,J=I/5,K=0,L=0;return requirejs(["hammer"],function(b){b(a.$("#list")).on("panstart",function(a){console.log("panstart",J,a.center.x),a.center.x<J&&(K=1)})}),requirejs(["hammer"],function(b){b(a.$("#list")).on("panright",function(a){1==K&&(location.hash="type",console.log(a),K=0)})}),requirejs(["hammer"],function(b){b(a.$("#task")).on("panstart",function(a){console.log("panstart",J,a.center.x),a.center.x<J&&(L=1)})}),requirejs(["hammer"],function(b){b(a.$("#task")).on("panright",function(a){1==L&&(location.hash="list",console.log(a),L=0)})}),window.onhashchange=function(){var b=location.hash,c=a.$("."+g.substr(1)),d=a.$("."+b.substr(1));"#type"==g&&"#list"==b||"#list"==g&&"#task"==b?(a.removeClass(d,"hide"),a.addClass(c,"slide out"),a.addClass(d,"slide in"),setTimeout(function(){a.removeClass(c,"slide out"),a.removeClass(d,"slide in"),a.addClass(c,"hide")},225)):("#task"==g&&"#list"==b||"#list"==g&&"#type"==b)&&(a.removeClass(d,"hide"),a.addClass(c,"slide reverse out"),a.addClass(d,"slide reverse in"),"#task"==g&&"#list"==b&&s(),setTimeout(function(){a.removeClass(c,"slide reverse out"),a.removeClass(d,"slide reverse in"),a.addClass(c,"hide")},225)),g=b},{init:h,_addClick:i}});